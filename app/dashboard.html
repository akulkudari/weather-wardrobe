<!DOCTYPE html>
<html lang="en">
<head>
    <title>Weather App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        body,h1,h2,h3,h4,h5,h6 { font-family: "Lato", sans-serif; }
        .w3-bar,h1,button { font-family: "Montserrat", sans-serif; }
        .fa-cloud,.fa-comment { font-size: 200px; }
    </style>
</head>
<body>

<!-- Navbar -->
<div class="w3-top">
    <div class="w3-bar w3-blue w3-card w3-left-align w3-large">
        <a class="w3-bar-item w3-button w3-padding-large w3-white">Home</a>
        <a href="/profile" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Profile</a>
        <a href="/settings" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Settings</a>
        <a href="/login" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Login</a>
    </div>
</div>

<!-- Header -->
<header class="w3-container w3-blue w3-center" style="padding: 100px 16px">
    <h1 class="w3-margin w3-jumbo">Weather Dashboard</h1>
    <p class="w3-xlarge">Get real-time weather updates</p>
</header>

<!-- Weather Section -->
<div class="w3-row-padding w3-padding-64 w3-container">
    <div class="w3-content">
        <div class="w3-twothird">
            <h2>Weather Information</h2>
            <div id="infoContainer" class="w3-large"></div>
        </div>
        <div class="w3-third w3-center">
            <i class="fa fa-cloud w3-padding-64 w3-text-blue"></i>
        </div>
    </div>
</div>

<!-- AI Text Generator Section -->
<div class="w3-row-padding w3-light-grey w3-padding-64 w3-container">
    <div class="w3-content">
        <div class="w3-third w3-center">
            <i class="fa fa-comment w3-padding-64 w3-text-blue w3-margin-right"></i>
        </div>
        <div class="w3-twothird">
            <h2>AI Text Generator</h2>
            <textarea id="aiInput" class="w3-input w3-border" rows="4" placeholder="Enter your text prompt..."></textarea>
            <button class="w3-button w3-blue w3-margin-top" onclick="generateText()">Generate</button>
            <p id="aiOutput" class="w3-large"></p>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="w3-container w3-padding-64 w3-center w3-opacity">
    <div class="w3-xlarge w3-padding-32">
        <i class="fa fa-facebook-official w3-hover-opacity"></i>
        <i class="fa fa-instagram w3-hover-opacity"></i>
        <i class="fa fa-twitter w3-hover-opacity"></i>
        <i class="fa fa-linkedin w3-hover-opacity"></i>
    </div>
    <p>Designed by Akul Kudari and Sherif Elfiky</p>
</footer>

<script>
// Fetch user location and weather data
document.addEventListener("DOMContentLoaded", async function () {
    try {
        const userResponse = await fetch("/user_info", { credentials: "include" });
        if (!userResponse.ok) throw new Error("Failed to fetch user information");

        const userData = await userResponse.json();
        if (!userData || !userData.location) {
            console.warn("No location data available");
            return;
        }

        console.log("User location:", userData.location);

        const { lat, lon } = await getCoordinates(userData.location);
        if (lat && lon) {
            getWeather(lat, lon, userData.location);
        } else {
            console.error("Failed to get coordinates for:", userData.location);
        }
    } catch (error) {
        console.error("Error fetching user location:", error);
    }
});

async function getCoordinates(city) {
    try {
        const encodedCity = encodeURIComponent(city);
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodedCity}&format=json`);
        if (!response.ok) throw new Error("Failed to fetch city coordinates");

        const data = await response.json();
        if (data.length === 0) throw new Error("City not found");

        return { lat: data[0].lat, lon: data[0].lon };
    } catch (error) {
        console.error("Error getting coordinates:", error);
        return { lat: null, lon: null };
    }
}

async function getWeather(lat, lon, location) {
    try {
        console.log(`Fetching weather for: Lat=${lat}, Lon=${lon}`);
        const weatherResponse = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
        if (!weatherResponse.ok) throw new Error("Failed to fetch weather data");

        const weatherData = await weatherResponse.json();
        const forecastUrl = weatherData.properties.forecast;

        const forecastResponse = await fetch(forecastUrl);
        if (!forecastResponse.ok) throw new Error("Failed to fetch forecast data");

        const forecastData = await forecastResponse.json();
        const weather = forecastData.properties.periods[0];

        document.getElementById("infoContainer").innerHTML = `
            <p><strong>Location:</strong> ${location}</p>
            <p><strong>Conditions:</strong> ${weather.shortForecast}</p>
            <p><strong>Temperature:</strong> ${weather.temperature} Â°${weather.temperatureUnit}</p>
        `;
    } catch (error) {
        console.error("An error occurred while fetching weather data:", error);
    }
}
    let index = 0;
    function typeWriterEffect() {
            if (index < text.length) {
                outputContainer.innerHTML += text[index];
                index++;
                setTimeout(typeWriterEffect, 20); // Adjust speed here
            }
        }
        typeWriterEffect();

    async function generateText() {
        const prompt = document.getElementById("aiInput").value.trim();
        if (!prompt) {
            alert("Please enter a text prompt.");
            return;
        }
        try {
            const userResponse = await fetch("/user_info", { credentials: "include" });
            if (!userResponse.ok) {
                throw new Error("Failed to fetch user information");
            }
            const userData = await userResponse.json();
            
            if (!userData || !userData.location) {
                console.warn("No location data available");
                return;
            }
            const formData = new FormData();
            formData.append("email", userData.email);
            formData.append("PID", userData.PID);
            formData.append("prompt", prompt);
            const response = await fetch("/getairesponse", {
                method: "POST",
                body: formData
            });


            if (!response.ok) {
                throw new Error("Failed to generate text");
            }
            
            const data = await response.json();
            document.getElementById("aiOutput").innerText = data.response;
        } catch (error) {
            console.error("Error generating text:", error);
            alert("Failed to generate text.");
        }
    }
</script>

</body>
</html>



<!--
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sensor Data Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Sensor Data Dashboard</h1>
    <nav>
      <a href="/">Home</a>
    </nav>
  </header>
  
  <main>
    <section>
      <h2>Temperature Data</h2>
      <canvas id="temperatureChart"></canvas>
    </section>
    <section>
      <h2>Humidity Data</h2>
      <canvas id="humidityChart"></canvas>
    </section>
    <section>
      <h2>Light Data</h2>
      <canvas id="lightChart"></canvas>
    </section>
  </main>
<script src = "static/js/dashboard.js"></script>
</body>
</html>
-->